{% extends 'bases/home.html' %}
{% load static %}
{% block breadcrumbs %}
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    {% if lista_deposito != 'Cuentas cliente' %}
                    <li><a href="#">operaciones</a></li>
                    <li><a href="#">cobranzas</a></li>
                    <li><a href="#">confirma o protesta</a></li>
                    <li class="active">protesto de cheque</li>
                    {% else %}
                    <li><a href="#">Extras</a></li>
                    <li><a href="#">Cuentas conjuntas</a></li>
                    <li><a href="#">Confirmar cobranzas</a></li>
                    <li class="active">protesto de cheque</li>
                    {% endif %}
                </ol>
            </div>
        </div>
    </div>
{% endblock breadcrumbs %}
{% block content %}
<form  method="post" id="frmSolicitud" enctype="multipart/form-data" class="form-horizontal">
    <div class="col-lg-6">
        <div class="card">
                {% csrf_token %}
            <div class="card-header">
                <strong>Protesto</strong> 
                de {{ cheque.cxparticipante }}
            </div>
            <!-- <div hidden>
                <input type="text" value="{{ id_cliente }}" id="id_cliente">
                <input type="text" value="{{ forma_cobro }}" id="forma_cobro">
                <input type="text" value="{{ codigo_cobranza }}" id="codigo_cobranza">
                <input type="text" value="{{ cobranza.id }}" id="id_cobranza">
                <input type="text" value="{{ cobranza.cxtipofactoring.id }}" id="tipo_factoring">
                <input type="text" value="{{ cobranza.cxaccesorio.id }}" id="id_accesorio">
                <input type="text" value="{{ cheque.id }}" id="id_cheque">
                <input type="text" value="{{ cheque.nvalor|floatformat:"2u"  }}" id="valor_cheque">
                <input type="text" value="{{ cheque.cxtipoparticipante }}" id="tipo_emisor">
                <input type="text" value="{{ tipo_operacion }}" id="tipo_operacion">
            </div> -->
            <div class="card-body card-block">
                    <!-- columna izquierda -->
                    <!-- <div class="col-6"> -->
                            <!-- fechas -->
                        <div class="row form-group">
                            <div class="col-md-5"><label for="id_ddesembolso" class=" form-control-label">
                                Operación
                            </label></div>
                            <div class="col-md-7">
                                {{ cobranza}}
                            </div>
                        </div>  
                        <div class="row form-group">
                            <div class="col-md-5"><label for="id_ddesembolso" class=" form-control-label">
                                Cheque
                            </label></div>
                            <div class="col-md-7">
                                {{ cheque}}
                            </div>
                        </div>  
                        
                        <div class="row form-group">
                            <div class="col col-md-5"><label for="id_ctinstrucciondepago" class=" form-control-label">
                                Girador</label></div>
                            <div class="col-md-7">
                                {{ cheque.ctgirador}}
                            </div>
                        </div>  
                        <div class="row form-group">
                            <div class="col col-md-5"><label for="id_ctinstrucciondepago" class=" form-control-label">
                                Valor</label></div>
                            <div class="col-md-7">
                                {{ cheque.nvalor}}
                            </div>
                        </div>  
                        <div class="row form-group">
                            <div class="col col-md-5"><label for="id_nvalor" class=" form-control-label">
                               Fecha de depósito
                            </label></div>
                            <div class="col-md-7">
                                {{ cobranza.ddeposito|date:"Y-m-d" }}
                            </div>
                        </div>  
                        <div class="dropdown-divider"></div>
                        <div class="row form-group">
                            <div class="col col-md-5"><label for="id_dprotesto" class=" form-control-label">
                                {{ form.dprotesto.label}}
                            </label></div>
                            <div class="col-md-7">
                                {{ form.dprotesto }}
                            </div>
                        </div>  
                        <div class="row form-group">
                            <div class="col col-md-5">
                                <label for="id_motivoprotesto" class=" form-control-label">
                                    {{ form.motivoprotesto.label }}</label>
                            </div>
                            <div class="col-md-7">
                                {{ form.motivoprotesto }}
                            </div>
                        </div>  
                        <div class="row form-group">
                            <div class="col col-md-5">
                                <label for="id_nvalornotadebito" class=" form-control-label">
                                    Valor de la nota débito</label>
                            </div>
                            <div class="col-md-7">
                                <input type="number" name="nvalornotadebito" 
                                value="0.0" step="any" class="form-control" 
                                required id="id_nvalornotadebito">                            </div>
                        </div>  
                <!-- </div> -->
            </div>    
            <div class="card-footer">
                <a 
                {% if lista_deposito == 'Cuentas cliente' %}
                    href="{% url 'cuentasconjuntas:listacobranzasporconfirmar' %}"
                {% else %}
                    href="{% url 'cobranzas:listacobranzasporconfirmar' %}"
                {% endif %}
                class="btn btn-danger btn-sm "><i class="fa fa-ban"></i> Cancelar
                </a>
                <button type="button" class="btn btn-primary btn-sm" onclick="AceptarProtesto()">  
                    <i class="fa fa-dot-circle-o"></i> Protestar
                </button>

            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block js_page %}
<!-- <script type="text/javascript" src="{% static 'factorweb/js/datosprotesto.js' %}"></script> -->
<script>
// const tipo_operacion = capturaValor("tipo_operacion")
const id_cliente = "{{ id_cliente }}"
const forma_cobro = "{{ forma_cobro }}"
const codigo_cobranza = "{{ codigo_cobranza }}"
const id_cobranza = "{{ cobranza.id }}"
const tipo_factoring = "{{ cobranza.cxtipofactoring.id }}"
const id_accesorio = "{{ cobranza.cxaccesorio.id }}"
const id_cheque = "{{ cheque.id }}"
const valor_cheque = "{{ cheque.nvalor }}"
const tipo_emisor = "{{ cheque.cxtipoparticipante }}"
const tipo_operacion = "{{ tipo_operacion }}"

window.onload=function(){
    // objeto_fechas("#id_dprotesto")
    const motivoInicial = capturaValor("id_motivoprotesto");
    if (motivoInicial) {
        validarValorNotaDebito(motivoInicial);
    }

    jQuery("#id_motivoprotesto").change(function() {
        validarValorNotaDebito(this.value);
    });
}

function validarValorNotaDebito(motivoId) {
    if (!motivoId) return;

    const inputNotaDebito = document.getElementById('id_nvalornotadebito');
    
    fetchRecuperar(`/cobranzas/motivo_responsabilidad/${motivoId}/`, function(data) {
        if (data.lresponsabilidadgirador) {
            inputNotaDebito.readOnly = false;
        } else {
            inputNotaDebito.value = "0.00";
            inputNotaDebito.readOnly = true;
        }
    });
}

function AceptarProtesto(){
    const motivoId = capturaValor("id_motivoprotesto");
    const valorNd = parseFloat(capturaValor("id_nvalornotadebito"));

    if (!motivoId) {
        MensajeError("Debe seleccionar un motivo de protesto.");
        return;
    }
    fetchRecuperar(`/cobranzas/motivo_responsabilidad/${motivoId}/`, function(data) {
        const esResponsable = data.lresponsabilidadgirador;

        if (esResponsable && (!valorNd || valorNd <= 0)) {
            MensajeError("Debe ingresar un valor de nota de débito para este motivo de protesto.");
            return;
        }

        if (!esResponsable && valorNd > 0) {
            MensajeError("No debe ingresar un valor de nota de débito para este motivo. El valor se establecerá en 0.");
            document.getElementById('id_nvalornotadebito').value = "0.00";
        }
  
        MensajeConfirmacion("Aceptar el protesto de " + codigo_cobranza +"?"
            ,function(){
            var tipo

            if (tipo_operacion=='Cobranza') {tipo = 'C'} else {tipo = 'R'}

            var objeto={
                "id_cliente":id_cliente,
                "tipo_factoring":tipo_factoring,
                "forma_cobro":forma_cobro,
                "id_cobranza" :id_cobranza,
                "codigo_cobranza" : codigo_cobranza,
                "id_cheque":id_cheque,
                "valor" :valor_cheque, 
                "fecha_protesto":capturaValor("id_dprotesto"), 
                "valor_nd": valorNd, 
                "motivoprotesto" : motivoId,
                "tipo_emisor":tipo_emisor,
                "id_accesorio":id_accesorio,
                "tipo_operacion":tipo
                }
            console.log(objeto)    
            fetchPostear("/cobranzas/aceptarprotesto/", objeto, function(data){
                // en una nueva ventana abrir el reporte de cobranza
                url = window.location.origin
                if (tipo_operacion=="Cobranza"){
                    url = url + "/cobranzas/reportecobranzacartera/"+data;
                }
                else{
                    url = url + "/cobranzas/reporterecuperacion/"+data;
                }
                window.open( url);
                // regresar a la lista de solicitudes
                window.location.href = "/cobranzas/listacobranzasporconfirmar";
                })
            })
    });
}
   
      
</script>
{% endblock %}
