{% extends 'bases/home.html' %}
{% load static %}
{% block breadcrumbs %}
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    <li><a href="#">cobranzas</a></li>
                    {% if tipo_asignacion == 'A'%}
                    <li><a href="{% url 'cobranzas:listachequesadepositar' %}">
                        depósito de cheques</a></li>
                    {% else %}
                    <li><a href="{% url 'cobranzas:listadocumentosvencidos' %}">
                        cartera vencida</a></li>
                    {% endif %}
                    <li class="active">ampliación de plazo</li>
                </ol>
            </div>
        </div>
    </div>
{% endblock breadcrumbs %}
{% block content %}
<form  method="post" id="frmSolicitud" enctype="multipart/form-data" class="form-horizontal">
    <!-- <div class="col-lg-6"> -->
    <div class="card">
            {% csrf_token %}
        <div class="card-header">
            <strong>Ampliación de plazo</strong> 
            de  {{ cliente }} 
        </div>
        <div class="col-6 col-md-6" hidden>
            <input id="acumula_gao" name="acumula_gao" value="{{ gaoa.acumula_gao }}" >
            <input id="carga_dc" name="carga_dc" value="{{ dc.generar }}" >
            <input id="tipo_asignacion" name="tipo_asignacion" value="{{ tipo_asignacion }}" >
            <input id="iva_gaoa" name="iva_gaoa" value="{{ gaoa.carga_iva }}" >
            <input id="iva_dc" name="iva_dc" value="{{ dc.carga_iva }}" >
            <input id="ids" name="ids" value="{{ ids }}" >              
            <input id="id_cliente" name="id_cliente" value="{{ id_cliente }}" >
            <input id="tipo_factoring" name="tipo_factoring" value="{{ tipo_factoring }}" >
            <input id="iniciales_dc" name="iniciales_dc" value="{{ dc.iniciales }}" >
            <input id="iniciales_gaoa" name="iniciales_gaoa" value="{{ gaoa.iniciales }}" >
        </div>
            <div class="card-body card-block">
                <!-- columna izquierda -->
                <div class="col-5">
                        <!-- fechas -->
                    <div class="row form-group">
                        <div class="col-md-6"><label for="fechacorte" class=" form-control-label">
                            Ampliar hasta:
                        </label></div>
                        <div class="col-md-6">
                            <input type="date" class="form-control" name="fechacorte"  
                            id="fechacorte" placeholder="Ingrese fecha de corte" 
                            value="{% now 'Y-m-d' %}">
                        </div>
                    </div>  
                       
                    <div class="row form-group">
                        <div class="col-md-6"><label for="fechacorte" class=" form-control-label">
                            Emisión de nota de débito:
                        </label></div>
                        <div class="col-md-6">
                            <input type="date" class="form-control" name="emision_nd"  
                            id="emision_nd" readonly
                            value="{% now 'Y-m-d' %}">
                        </div>
                    </div>  

                    <div class="col-md-12">
                        <div class="alert alert-info" role="alert">
                            La ampliación de plazo genera una nota de débito que debe convertirse en factura.
                            Para el cobro vaya a la opción 
                            OPERACIONES / Cobranzas / Cargos pendientes.
                        </div>
                     </div>
                       
                </div>
                <!-- columna derecha -->
                <div class="col-7">
                    <h5 class="heading-title mb-1 text-secondary">Valores por ampliación</h5>
                    <div class="row form-group">
                        <div class="col col-md-12">
                            <h5 for="id_ctinstrucciondepago" class=" form-control-label">
                            Cargos</h5></div>
                    </div>  
                    <div class="row form-group">
                        <div class="col-md-1"></div>
                        <div class="col col-xs-3">
                            <label for="id_ngao" class=" form-control-label">
                                {{gaoa.descripcion}}</label></div>
                        <div class="col-6 col-md-6">
                            <input type="text" id="id_ngaoa" name="id_ngaoa" readonly
                            class="form-control">                                        
                        </div>
                    </div>  
                    <div class="row form-group">
                        <div class="col-md-1"></div>
                        <div class="col col-xs-3">
                            <label for="id_ndescuentodecartera" class=" form-control-label">
                                {{dc.descripcion}}</label></div>
                        <div class="col-6 col-md-6">
                            <input type="text" id="id_ndescuentodecartera" name="id_ndescuentodecartera" 
                            class="form-control" readonly>      
                        </div>
                    </div>  
                    <div class="row form-group">
                        <div class="col-md-1"></div>
                        <div class="col-md-1">
                            <label for="id_niva" class=" form-control-label">
                            IVA
                        </label></div>
                        <div class="col-md-3">
                            <input type="number" name="neto" step="0.01" class="form-control" 
                            readonly id="porcentaje_iva" value="{{ porcentaje_iva }}">
                        </div>
                        <div class="col-md-1"></div>
                        <div class="col-6 col-md-6">
                            <input type="text" id="id_niva" name="id_niva" readonly
                            class="form-control">      
                        </div>
                    </div>  
                    <div class="row form-group">
                        <!-- <div class="col col-xs-3"><label for="id_cxtipocliente" 
                            class=" form-control-label">= Neto</label></div> -->
                        <div class="col col-md-6">
                            <h5 for="id_nvalor" class=" form-control-label">
                            Total
                            </h5></div>
                        <div class="col-6 col-md-6">
                            <input type="number" name="total" step="0.01" 
                            class="form-control" readonly id="total">
                        </div>
                    </div>  
                </div>
                <!-- parte inferior -->
                <div class="row form-group">
                    <!-- <small> -->

                    <div class="col-md-12">
                          
                        <table id="table"                      
                            data-show-columns-toggle-all="true"
                            data-show-export="true"
                            data-detail-formatter="detailFormatter"
                            data-minimum-count-columns="2"
                            data-pagination="false"
                            data-id-field="id"
                            data-page-list="[10, 50, all]"
                            data-show-footer="true"
                            data-side-pagination="server"
                            data-search="true"
                            >
                        </table>

                    </div>

                    <!-- </small> -->
               </div>
            </div>    
        <div class="card-footer">
            <a 
            {% if tipo_asignacion == 'A' %}
               href="{% url 'cobranzas:listachequesadepositar' %}" 
            {% else %}
                href="{% url 'cobranzas:listadocumentosvencidos' %}" 
            {% endif %}
                class="btn btn-danger btn-sm "><i class="fa fa-ban"></i> Cancelar
            </a>
            <button type="button" onclick="AceptarAmpliacionPlazo()" class="btn btn-primary btn-sm ">
                <i class="fa fa-dot-circle-o"></i> Aceptar
            </button>
        </div>
    </div>
    <!-- </div> -->
</form>
{% endblock %}
{% block js_page %}
<!-- <script type="text/javascript" src="{% static 'factorweb/js/datosampliacionplazo.js' %}"></script> -->
<script>
const $table = jQuery('#table')
const acumula_gao = capturaValor("acumula_gao")
const carga_dc = capturaValor("carga_dc")
const tipo_asignacion = capturaValor("tipo_asignacion")
const porcentaje_iva = capturaValor("porcentaje_iva")
const iva_gaoa = capturaValor("iva_gaoa")
const iva_dc = capturaValor("iva_dc")
const ids = capturaValor("ids")
const id_cliente = capturaValor("id_cliente")
var iniciales_dc = capturaValor("iniciales_dc")
var iniciales_gaoa = capturaValor("iniciales_gaoa")
var selections = []
var base_iva = 0

window.onload=function(){
  //  // cerrar side bar
  //   CerrarSideBar();
 
        
    jQuery('#fechacorte')
        .change(function(){
          RecalcularCargos(ids,capturaValor("fechacorte"));
        });

    // inicializar tabla
    if (iniciales_dc==''){iniciales_dc='DCAR'}
    if (iniciales_gaoa==''){iniciales_gaoa='GAOA'}

    initTable(iniciales_gaoa,iniciales_dc);

    // mostrar valores
    RecalcularCargos( ids, capturaValor("fechacorte"));

  };

window.operateEvents = {
  'click .editar': function (e, value, row, index) {
    CambiarTasasDocumento(row.id,capturaValor("fechacorte"), row.Tipo_documento,function(){
    })
  },
};

function operateFormatter(value, row, index) {
  return [
    '<a class="editar" href="javascript:void(0)" title="Configurar tasas">',
    '<i class="fa fa-cog"></i>',
    '</a>  '
  ].join('')
}
  
function RecalcularCargos(ids,fecha_corte){
  // el formato usado es yyyy-mm-dd. Esta validación necesaria pues al digitar la fecha
  // su pueden tener meses y dias como '00'
  var isValid = fecha_corte.match(/^\d{4}(\-)(((0)[0-9])|((1)[0-2]))(\-)([0-2][0-9]|(3)[0-1])$/);

  if (isValid) {
    fetchProcesar("/cobranzas/detallecargosampliaciondeplazo/"+ids+"/"+tipo_asignacion
      +"/"+ fecha_corte +"/" + carga_dc + "/" + acumula_gao + '/' + id_cliente, function(){
            RefrescarTabla(ids, tipo_asignacion)
        }) 
  } 

}

function RefrescarTabla(ids, tipo_asignacion){
  // se invoca desde modal de cambio de tasa
  $table.bootstrapTable('refresh', {
    url: "/cobranzas/refrescadetallecargosampliacionplazo/" + ids + "/" + tipo_asignacion
  });
  Suma_Cargos(ids, iva_gaoa, iva_dc, porcentaje_iva )
}

function Suma_Cargos(ids, iva_gaoa, iva_dc, porcentaje_iva){
  fetchRecuperar("/cobranzas/sumacargos/"+ids+"/"+tipo_asignacion+"/"+iva_gaoa+"/"
              +iva_dc+"/"+porcentaje_iva
    , function(data){
    if (data){
      jQuery("#id_ndescuentodecartera").val(data['dc'])
      jQuery("#id_ngaoa").val(data['gaoa'])    
      jQuery("#id_niva").val(data['iva'])    
      jQuery("#total").val(data['total'])   
      base_iva = data['base_iva'] 
    }
  })
}

function initTable(iniciales_GAOA, iniciales_DC) {

    $table.bootstrapTable('destroy').bootstrapTable({
      locale: "es-EC",
      columns: [
        [{title: 'Ref.', field: 'id', rowspan: 2, align: 'center', valign: 'middle', 
          sortable: true, footerFormatter: LineaTotalEnPieDePaginaDeTabla
          }, {title: 'Asignación', field: 'Asignacion', rowspan: 2, align: 'center', 
          valign: 'middle', sortable: true, footerFormatter: LineaCantidadEnPieDePaginaDeTabla
          }, {title: 'Documento', field: 'Documento', rowspan: 2, align: 'center', 
          valign: 'middle', sortable: true,
          }, {title: 'Saldo', field: 'Saldo', rowspan: 2, align: 'center', valign: 'middle', 
          sortable: true, footerFormatter: LineaTotalValoresEnPieDepaginaDeTabla
          }, {title: 'Última generación', field: 'UltimaGeneracioncargos', rowspan: 2, align: 'center', 
          valign: 'middle', sortable: true,
          }, {title: 'Plazo', field: 'Plazo', rowspan: 2, align: 'center', valign: 'middle', 
          sortable: true, 
          }, {title: iniciales_GAOA, colspan: 2, align: 'center'
          }, {title: iniciales_DC, colspan: 2, align: 'center'
          
          }, {field: 'operate', title: 'Acción',rowspan: 2, align: 'center', valign: 'middle'
          , clickToSelect: false, events: window.operateEvents, formatter: operateFormatter
          }],
        [ {field: 'Tasa_GAOA', title: '%', sortable: true, align: 'center'
          }, {field: 'Valor_GAOA', title: 'valor', sortable: true, align: 'center', 
          footerFormatter: LineaTotalValoresEnPieDepaginaDeTabla
          }, {field: 'Tasa_DC', title: '%', sortable: true, align: 'center'
          }, {field: 'Valor_DC', title: 'valor', sortable: true, align: 'center', 
          footerFormatter: LineaTotalValoresEnPieDepaginaDeTabla
        }]
      ],
      
    })
}

function CambiarTasasDocumento(doc_id, fecha_ampliacion, tipo_asignacion, callback){
  AbrirModal("/cobranzas/editartasasdocumento/"+ doc_id+"/"+fecha_ampliacion+"/"
    +tipo_asignacion)
  
}

function AceptarAmpliacionPlazo(){
  var JSONdocumentos= JSON.stringify($table.bootstrapTable('getData'));

  MensajeConfirmacion("Aceptar ampliación de plazo para el " 
    + capturaValor("fechacorte") +"?",function(){
    var objeto={
        "id_cliente":id_cliente,
        "tipo_factoring":capturaValor("tipo_factoring"),
        "tipo_asignacion":tipo_asignacion,
        "emision_nd":capturaValor("emision_nd"),
        "fecha_corte": capturaValor("fechacorte"), 
        "ngao":capturaValor("id_ngaoa"), 
        "ndescuentocartera": capturaValor("id_ndescuentodecartera"),
        "niva": capturaValor("id_niva"),
        "valor_ampliacion": capturaValor("total"),
        "porcentaje_iva":porcentaje_iva,
        "arr_documentos_ampliados": JSONdocumentos,
        "base_iva": base_iva
      }

      fetchPostear("/cobranzas/aceptarampliaciondeplazo/", objeto, function(data){
        // en una nueva ventana abrir el reporte de ampliacion
        url = window.location.origin
        url = url + "/cobranzas/reporteampliacion/"+data;
        window.open( url);
        // regresar a la lista dependiendo dónde estaba
        if(tipo_asignacion=='A'){
          window.location.href = "/cobranzas/listachequesadepositar";
        }
        else{
          window.location.href = "/cobranzas/listadocumentosvencidos";
        }
      })
  })
    
}

</script>
{% endblock %}
