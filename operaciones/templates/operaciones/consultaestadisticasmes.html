{% extends 'bases/home.html' %}
{% load static %}
{% block breadcrumbs %}
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    <li><a href="#">análisis</a></li>
                    <li><a href="#">cartera</a></li>
                    <li class="active">estadísticas</li>
                </ol>
            </div>
        </div>
    </div>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
{% endblock breadcrumbs %}
{% block content %}
<div class="card bg-flat-color-0">
    <div class="card-body">
        <div class="row form-group ">
            <!-- <div class="col-md-1">Desembolso:</div> -->
            <div class="col-md-1">Desde:</div>
            <div class="col-md-3">
                <input type="month" class="form-control" name="fechadesde" 
                id="fechadesde" placeholder="Desde" >
            </div>
            <div class="col-md-1">
                <button class="btn btn-success btn-sm"  role="button" id="btnFiltrar">  
                    <i class="fa fa-filter"></i> Filtrar
                </button>
            </div>

        </div>
    </div>
</div>
<div class="content mt-3">
    <!-- totales -->
        <div class="col-md-12 col-lg-12">
            <!-- total cartera y protestos -->
            <!-- total negociado -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="ti-file text-success border-success"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Total negociado</div>
                                <div class="stat-digit">{{ acumulado_montos|floatformat:"2g"}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- total ingresos año -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="ti-files text-primary border-primary"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Total operaciones</div>
                                <div class="stat-digit">{{ acumulado_cantidades|floatformat:"g"}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- total ingresos año -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="ti-user text-info border-info"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Clientes nuevos</div>
                                <div class="stat-digit">{{ clientes_nuevos|floatformat:"g"}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- total ingresos año -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="ti-money text-danger border-danger"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Cobros realizados</div>
                                <div class="stat-digit">{{ acumulado_cobros|floatformat:"2g"}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- grafico cartera negociada -->
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="mb-3">Cantidad de operaciones y montos negociados </h4>
                        <!-- <canvas id="lineChart"></canvas> -->
                        <canvas id="negociacionesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- grafico cartera negociada -->
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="mb-3">Cobranzas por día </h4>
                        <canvas id="valoresCobradosChart" ></canvas>
                    </div>
                </div>
            </div>
        </div>
</div>        
{% endblock %}
{% block js_page %}
    <script src="{% static 'factorweb/vendors/chart.js/dist/Chart.bundle.min.js' %}"></script>
    <script>
    var $btnFiltrar = jQuery('#btnFiltrar')
    var periodo = "{{ periodo }}"

    window.onload=function(){
    
        inicializaValor("fechadesde", periodo)
    
        // boton de refrescar filtro
        $btnFiltrar.click(function () {
    
            periodo = capturaValor("fechadesde");
            var [year, month] = periodo.split('-');
            window.location.href = "/operaciones/negociaciones/" + year + "/" + month;
    
        })
    
    
        // // cerrar side bar
        // CerrarSideBar();
      
    };
        // primer gráfico
        var ctx1 = document.getElementById('negociacionesChart').getContext('2d');
        var negociacionesChart = new Chart(ctx1, {
            type: 'bar', // Tipo de gráfico base
            data: {
                labels: {{ fechas|safe }},
                datasets: [
                    {
                        label: 'Montos',
                        type: 'bar',
                        data: {{ montos|safe }},
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        yAxisID: 'y-axis-montos'
                    },
                    {
                        label: 'Cantidad',
                        type: 'line',
                        data: {{ cantidades|safe }},
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1,
                        fill: false,
                        yAxisID: 'y-axis-cantidad'
                    }
                ]
            },
            options: {
                responsive: true,
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    yAxes: [
                        {
                            id: 'y-axis-montos',
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                beginAtZero: true
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Montos'
                            }
                        },
                        {
                            id: 'y-axis-cantidad',
                            type: 'linear',
                            position: 'right',
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1, // Forzar que la escala sea en números enteros
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : null;
                                }
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Cantidad'
                            }
                        }
                    ]
                }
            }
        });
        // segundo gráfico
        var ctx2 = document.getElementById('valoresCobradosChart').getContext('2d');
        var valoresCobradosChart = new Chart(ctx2, {
            type: 'bar', // Tipo de gráfico base
            data: {
                labels: {{ fechas_cobranzas|safe }},
                datasets: [
                    {
                        label: 'Valores Cobrados',
                        data: {{ valores|safe }},
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });

    </script>
{% endblock %}